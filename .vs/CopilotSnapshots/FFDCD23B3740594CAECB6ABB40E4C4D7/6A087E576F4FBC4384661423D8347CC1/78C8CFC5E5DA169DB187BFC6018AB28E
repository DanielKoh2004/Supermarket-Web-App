using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Web.UI;
using System.Web.UI.WebControls;
using WebApplication1.Models;

namespace WebApplication1
{
    public partial class Menu : System.Web.UI.Page
    {
        string connStr = System.Configuration.ConfigurationManager.ConnectionStrings["OnlineOrderSystemConnection"].ConnectionString;

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                LoadMenuItems(); // Load all items first time
            }
        }
        protected void btnSearch_Click(object sender, EventArgs e)
        {
            string keyword = txtSearch.Text.Trim();

            using (SqlConnection conn = new SqlConnection(connStr))
            {
                string query = "SELECT ItemID, ItemName, Category, UnitPrice, StockQuantity, ImageFile FROM Item " +
                               "WHERE ItemName LIKE @Keyword OR Category LIKE @Keyword";

                SqlDataAdapter da = new SqlDataAdapter(query, conn);
                da.SelectCommand.Parameters.AddWithValue("@Keyword", "%" + keyword + "%");

                DataTable dt = new DataTable();
                da.Fill(dt);

                rptMenu.DataSource = dt;
                rptMenu.DataBind();
            }
        }

        protected void imgCart_Click(object sender, ImageClickEventArgs e)
        {
            // Navigate to the shopping cart page
            Response.Redirect("~/ShoppingCart.aspx");
        }

        private void LoadMenuItems(string category = "")
        {
            using (SqlConnection conn = new SqlConnection(connStr))
            {
                string query = "SELECT ItemID, ItemName, Category, UnitPrice, StockQuantity, ImageFile FROM Item";

                if (!string.IsNullOrEmpty(category))
                {
                    query += " WHERE Category = @Category";
                }

                SqlDataAdapter da = new SqlDataAdapter(query, conn);

                if (!string.IsNullOrEmpty(category))
                {
                    da.SelectCommand.Parameters.AddWithValue("@Category", category);
                }

                DataTable dt = new DataTable();
                da.Fill(dt);

                rptMenu.DataSource = dt;
                rptMenu.DataBind();
            }
        }

        // 🔹 Dropdown filter event
        protected void ddlCategory_SelectedIndexChanged(object sender, EventArgs e)
        {
            string selectedCategory = ddlCategory.SelectedValue;

            if (string.IsNullOrEmpty(selectedCategory))
            {
                LoadMenuItems(); // All items
            }
            else
            {
                LoadMenuItems(selectedCategory); // Filtered items
            }
        }

        // 🔹 Add to Cart button
        protected void btnAddToCart_Click(object sender, EventArgs e)
        {
            var btn = (Button)sender;
            int itemId = Convert.ToInt32(btn.CommandArgument);

            // Retrieve cart from Session
            List<CartItem> cart;
            if (Session["Cart"] == null)
            {
                cart = new List<CartItem>();
            }
            else
            {
                cart = (List<CartItem>)Session["Cart"];
            }

            // Check if item already exists in cart
            var existingItem = cart.Find(i => i.ItemID == itemId);
            int newQty = 1; // Default quantity if new item
            if (existingItem != null)
            {
                existingItem.Quantity += 1; // 🔹 increment quantity
                newQty = existingItem.Quantity;
            }
            else
            {
                // Get item details from DB
                using (SqlConnection conn = new SqlConnection(connStr))
                {
                    string query = "SELECT ItemName, UnitPrice FROM Item WHERE ItemID = @ItemID";
                    SqlCommand cmd = new SqlCommand(query, conn);
                    cmd.Parameters.AddWithValue("@ItemID", itemId);

                    conn.Open();
                    SqlDataReader reader = cmd.ExecuteReader();
                    if (reader.Read())
                    {
                        cart.Add(new CartItem
                        {
                            ItemID = itemId,
                            Name = reader["ItemName"].ToString(),
                            Price = Convert.ToDecimal(reader["UnitPrice"]),
                            Quantity = 1
                        });
                        // newQty remains 1 for new item
                    }
                }
            }

            Session["Cart"] = cart;

            // 🔹 Show success message with quantity
            lblSuccess.Text = $"✅ Added to cart successfully! Quantity: {newQty}";
        }


        protected void rptMenu_ItemCommand(object source, RepeaterCommandEventArgs e)           
        {
            if (e.CommandName == "add")
            {
                int productId = Convert.ToInt32(e.CommandArgument);
                int accountId = Convert.ToInt32(Session["AccountID"]); // Must store AccountID after login

                // Check if accountId is valid
                if (accountId <= 0)
                {
                    lblSuccess.Text = "❌ Please log in to add items to your cart.";
                    return;
                }

                using (SqlConnection con = new SqlConnection(connStr))
                {
                    con.Open();

                    // 1. Check if user already has a cart
                    string cartQuery = "SELECT CartID FROM Cart WHERE AccountID=@AccountID";
                    SqlCommand cmd = new SqlCommand(cartQuery, con);
                    cmd.Parameters.AddWithValue("@AccountID", accountId);
                    object cartIdObj = cmd.ExecuteScalar();

                    int cartId;
                    if (cartIdObj == null)
                    {
                        // Create new cart (no CreatedDate)
                        string insertCart = "INSERT INTO Cart (AccountID) OUTPUT INSERTED.CartID VALUES (@AccountID)";
                        SqlCommand cmdInsert = new SqlCommand(insertCart, con);
                        cmdInsert.Parameters.AddWithValue("@AccountID", accountId);
                        cartId = (int)cmdInsert.ExecuteScalar();
                    }
                    else
                    {
                        cartId = (int)cartIdObj;
                    }

                    // 2. Check if item already in cart
                    string itemCheck = "SELECT CartItemID, Quantity FROM CartItem WHERE CartID=@CartID AND ProductID=@ProductID";
                    SqlCommand cmdItem = new SqlCommand(itemCheck, con);
                    cmdItem.Parameters.AddWithValue("@CartID", cartId);
                    cmdItem.Parameters.AddWithValue("@ProductID", productId);

                    SqlDataReader rdr = cmdItem.ExecuteReader();
                    if (rdr.Read())
                    {
                        // Already in cart → update quantity
                        int currentQty = Convert.ToInt32(rdr["Quantity"]);
                        int cartItemId = Convert.ToInt32(rdr["CartItemID"]);
                        rdr.Close();

                        string updateQty = "UPDATE CartItem SET Quantity=@Qty WHERE CartItemID=@CartItemID";
                        SqlCommand cmdUpdate = new SqlCommand(updateQty, con);
                        cmdUpdate.Parameters.AddWithValue("@Qty", currentQty + 1);
                        cmdUpdate.Parameters.AddWithValue("@CartItemID", cartItemId);
                        cmdUpdate.ExecuteNonQuery();
                    }
                    else
                    {
                        rdr.Close();
                        // Not in cart → insert new row
                        string insertItem = "INSERT INTO CartItem (CartID, ProductID, Quantity) VALUES (@CartID, @ProductID, @Qty)";
                        SqlCommand cmdInsertItem = new SqlCommand(insertItem, con);
                        cmdInsertItem.Parameters.AddWithValue("@CartID", cartId);
                        cmdInsertItem.Parameters.AddWithValue("@ProductID", productId);
                        cmdInsertItem.Parameters.AddWithValue("@Qty", 1);
                        cmdInsertItem.ExecuteNonQuery();
                    }
                }

                lblSuccess.Text = "✅ Added to cart successfully!";
            }
        }



        protected void rptMenu_ItemDataBound(object sender, RepeaterItemEventArgs e)
        {
            if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
            {
                // Find stock label and button
                Label lblOOS = (Label)e.Item.FindControl("lblOOS");
                Button btnAddToCart = (Button)e.Item.FindControl("btnAddToCart");

                // Get stock value from DataRowView
                var drv = (System.Data.DataRowView)e.Item.DataItem;
                int stock = Convert.ToInt32(drv["StockQuantity"]);

                if (stock <= 0)
                {
                    // Show "Out of stock"
                    lblOOS.Visible = true;
                    btnAddToCart.Visible = false;
                }
            }
        }

    }
}
