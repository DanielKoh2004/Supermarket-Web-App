using System;
using System.Data.SqlClient;
using System.Web.UI;
using WebApplication1.Helpers;

namespace WebApplication1
{
    public partial class Login : System.Web.UI.Page
    {
        // Handles login button click event
        protected void btnLogin_Click(object sender, EventArgs e)
        {
            // Get connection string from configuration
            string connStr = System.Configuration.ConfigurationManager.ConnectionStrings["OnlineOrderSystemConnection"].ConnectionString;
            // Get user input values
            string email = txtEmail.Text;
            string password = txtPassword.Text;
            string accountType = ddlLoginType.SelectedValue; // "Staff" or "Customer"

            using (SqlConnection conn = new SqlConnection(connStr))
            {
                conn.Open();
                // Query account by email and account type
                SqlCommand cmd = new SqlCommand(
                    "SELECT AccountID, Password FROM Account WHERE Email=@Email AND AccountType=@AccountType", conn);
                cmd.Parameters.AddWithValue("@Email", email);
                cmd.Parameters.AddWithValue("@AccountType", accountType);
                SqlDataReader reader = cmd.ExecuteReader();

                if (reader.Read())
                {
                    // Get account ID and stored password hash
                    string accountId = reader["AccountID"].ToString();
                    string storedHash = reader["Password"].ToString();
                    reader.Close();

                    // Verify password using PasswordHelper
                    if (PasswordHelper.VerifyPassword(password, storedHash))
                    {
                        // Store account info in session
                        Session["AccountID"] = accountId;
                        Session["AccountType"] = accountType;

                        if (accountType == "Staff")
                        {
                            // Get staff role from Staff table
                            SqlCommand cmdStaff = new SqlCommand("SELECT Role FROM Staff WHERE AccountID=@AccountID", conn);
                            cmdStaff.Parameters.AddWithValue("@AccountID", accountId);
                            var staffRole = cmdStaff.ExecuteScalar()?.ToString();
                            Session["Role"] = staffRole;
                            // Redirect staff to management page
                            Response.Redirect("StaffManagement.aspx");
                        }
                        else
                        {
                            // Redirect customer to home page
                            Response.Redirect("Home.aspx");
                        }
                    }
                    else
                    {
                        // Show error if password is incorrect
                        lblError.Text = "Invalid email, password, or account type.";
                    }
                }
                else
                {
                    // Show error if account not found
                    lblError.Text = "Invalid email, password, or account type.";
                }
            }
        }

        // Page load event (no special logic required currently)
        protected void Page_Load(object sender, EventArgs e)
        {

        }
    }
}
