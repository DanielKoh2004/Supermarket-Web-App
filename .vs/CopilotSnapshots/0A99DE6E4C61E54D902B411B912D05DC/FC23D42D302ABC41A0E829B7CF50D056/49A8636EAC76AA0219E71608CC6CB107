using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using WebApplication1.Helpers;
using System.Data.SqlClient;

namespace WebApplication1
{
    public partial class AdminMigratePasswords : System.Web.UI.Page
    {
        // Page load event (no special logic required currently)
        protected void Page_Load(object sender, EventArgs e)
        {

        }

        // Event handler for Migrate button click
        protected void btnMigrate_Click(object sender, EventArgs e)
        {
            // Get connection string from configuration
            string connStr = System.Configuration.ConfigurationManager.ConnectionStrings["OnlineOrderSystemConnection"].ConnectionString;
            // List to store accounts that need password updates
            var updates = new List<System.Tuple<int, string>>();
            int migratedCount = 0;
            using (SqlConnection conn = new SqlConnection(connStr))
            {
                conn.Open();
                // Select all AccountID and Password from Account table
                SqlCommand selectCmd = new SqlCommand("SELECT AccountID, Password FROM Account", conn);
                SqlDataReader reader = selectCmd.ExecuteReader();
                while (reader.Read())
                {
                    int accountId = (int)reader["AccountID"];
                    string plainPassword = reader["Password"].ToString();
                    // Only hash if not already hashed (base64 string length is 24 or 44 for PBKDF2)
                    if (plainPassword.Length < 24 || !plainPassword.Contains("="))
                    {
                        // Hash the plain password
                        string hashed = PasswordHelper.HashPassword(plainPassword);
                        // Add to update list
                        updates.Add(System.Tuple.Create(accountId, hashed));
                    }
                }
                reader.Close();

                // Update each account with the new hashed password
                foreach (var update in updates)
                {
                    SqlCommand updateCmd = new SqlCommand("UPDATE Account SET Password=@Password WHERE AccountID=@AccountID", conn);
                    updateCmd.Parameters.AddWithValue("@Password", update.Item2);
                    updateCmd.Parameters.AddWithValue("@AccountID", update.Item1);
                    updateCmd.ExecuteNonQuery();
                    migratedCount++;
                }
            }
            // Show result message
            lblResult.Text = $"Migration completed. {migratedCount} password(s) updated.";
        }
    }
}