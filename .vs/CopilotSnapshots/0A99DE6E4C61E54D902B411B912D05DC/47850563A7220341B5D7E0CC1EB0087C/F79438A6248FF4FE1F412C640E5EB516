using System;
using System.Data.SqlClient;
using System.Text.RegularExpressions;
using System.Web.UI;
using System.Web.UI.WebControls;
using WebApplication1.Helpers;

namespace WebApplication1
{
    public partial class ChangePassword : System.Web.UI.Page
    {
        // Connection string for database access
        string connStr = System.Configuration.ConfigurationManager.ConnectionStrings["OnlineOrderSystemConnection"].ConnectionString;

        // Page load event (no special logic required currently)
        protected void Page_Load(object sender, EventArgs e)
        {
        }

        // Event handler for Update Password button click
        protected void btnUpdatePassword_Click(object sender, EventArgs e)
        {
            // Ensure user is logged in
            if (Session["AccountID"] == null)
            {
                Response.Redirect("Login.aspx");
                return;
            }
            // Get current user's AccountID from session
            int accountId = Convert.ToInt32(Session["AccountID"]);
            // Retrieve and trim user input values
            string oldPassword = txtOldPassword.Text.Trim();
            string newPassword = txtNewPassword.Text.Trim();
            string confirmPassword = txtConfirmPassword.Text.Trim();

            // 1. Get the current user's password hash from the database using AccountID
            string dbPasswordHash = null;
            using (SqlConnection conn = new SqlConnection(connStr))
            {
                conn.Open();
                SqlCommand cmd = new SqlCommand("SELECT Password FROM Account WHERE AccountID = @AccountID", conn);
                cmd.Parameters.AddWithValue("@AccountID", accountId);
                var result = cmd.ExecuteScalar();
                if (result != null)
                    dbPasswordHash = result.ToString();
            }

            // 2. Check if the old password matches the current user's password (using hash)
            if (dbPasswordHash == null || !PasswordHelper.VerifyPassword(oldPassword, dbPasswordHash))
            {
                lblMessage.Text = "Old password is incorrect.";
                return;
            }

            // 3. Validate new password format
            if (!IsValidPassword(newPassword))
            {
                lblMessage.Text = "New password does not meet requirements.";
                return;
            }
            // Check if new password and confirm password match
            if (newPassword != confirmPassword)
            {
                lblMessage.Text = "New password and confirm password do not match.";
                return;
            }

            // 4. Hash the new password and update for the current user only
            string hashedNewPassword = PasswordHelper.HashPassword(newPassword);
            using (SqlConnection conn = new SqlConnection(connStr))
            {
                conn.Open();
                SqlCommand cmd = new SqlCommand("UPDATE Account SET Password = @Password WHERE AccountID = @AccountID", conn);
                cmd.Parameters.AddWithValue("@Password", hashedNewPassword);
                cmd.Parameters.AddWithValue("@AccountID", accountId);
                cmd.ExecuteNonQuery();
                // Show success message
                lblMessage.ForeColor = System.Drawing.Color.Green;
                lblMessage.Text = "Password updated successfully!";
            }
        }

        // Validates password according to defined rules
        private bool IsValidPassword(string password)
        {
            // Check for null/whitespace, length, and no spaces
            if (string.IsNullOrWhiteSpace(password) || password.Length < 8 || password.Length > 50)
                return false;
            if (password.Contains(" "))
                return false;
            // Check for uppercase, lowercase, digit, and special character
            if (!Regex.IsMatch(password, @"[A-Z]")) // Uppercase
                return false;
            if (!Regex.IsMatch(password, @"[a-z]")) // Lowercase
                return false;
            if (!Regex.IsMatch(password, @"\d")) // Number
                return false;
            if (!Regex.IsMatch(password, @"[!@#$%]")) // Special char
                return false;
            return true;
        }
    }
}